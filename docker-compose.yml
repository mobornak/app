version: '3.7'
services:
  nginx:
    image: 'nginx:1.19-alpine'
    ports:
      - '80:80'
    volumes:
      - './configurations/30-sl-nginx.entrypoint.sh:/docker-entrypoint.d/30-sl-nginx.entrypoint.sh:ro'
  postfix:
    image: 'arugifa/simplelogin-postfix:3.1.0-6'
    environment:
      POSTFIX_FQDN: sl.com
      ALIASES_DEFAULT_DOMAIN: sl.com
      DB_NAME: '${POSTGRES_DB}'
      DB_HOST: '${POSTGRES_HOST}'
      DB_USER: '${POSTGRES_USER}'
      DB_PASSWORD: '${POSTGRES_PASSWORD}'
      LETSENCRYPT_EMAIL: admin@sl.com
      EMAIL_HANDLER_HOST: email-handler
  postgres:
    image: 'postgres:12.1'
    environment:
      POSTGRES_USER: null
      POSTGRES_PASSWORD: null
      POSTGRES_DB: null
    volumes:
      - 'pgdata:/var/lib/postgresql/data'
  webapp:
    build: .
    env_file:
      - .env
    environment:
      DB_URI: 'postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:5432/${POSTGRES_DB}'
  email-handler:
    build: .
    env_file:
      - .env
    environment:
      DB_URI: 'postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:5432/${POSTGRES_DB}'
      LOCAL_FILE_UPLOAD: '1'
    command: python email_handler.py
  pgadmin:
    image: 'dpage/pgadmin4:4.29'
    ports:
      - '8080:80'
    environment:
      PGADMIN_DEFAULT_EMAIL: d@doanguyen.com
      PGADMIN_DEFAULT_PASSWORD: 112233
volumes:
  pgdata: null
networks:
  sl-network: null
